<div class="motwm-townie-maker">
  <nav class="tabs" data-group="primary-tabs">
    <a class="item" data-tab="template">
      <i class="fas fa-images"></i> Templates
    </a>
    <a class="item" data-tab="details">
      <i class="fas fa-edit"></i> Details
    </a>
    <a class="item" data-tab="abilities">
      <i class="fas fa-dice-d20"></i> Abilities
    </a>
    <a class="item" data-tab="config">
      <i class="fas fa-cog"></i> Config
    </a>
  </nav>

  <div class="content">
    <!-- Template Selection Tab -->
    <div class="tab" data-tab="template">
      <div class="section-header">Choose a Template</div>
      <div class="template-grid">
        {{#each templates}}
        <div class="template-card {{#if (eq ../selectedTemplate.id this.id)}}selected{{/if}}"
             data-action="select-template"
             data-template-id="{{this.id}}">
          <div class="icon"><i class="{{this.icon}}"></i></div>
          <div class="name">{{this.name}}</div>
          <div class="description">{{this.description}}</div>
        </div>
        {{/each}}
      </div>
    </div>

    <!-- Details Tab -->
    <div class="tab" data-tab="details">
      <div class="section-header">NPC Details</div>
      
      <div class="form-group">
        <label for="npc-name">Name *</label>
        <div style="display: flex; gap: 8px; align-items: stretch;">
          <input type="text" id="npc-name" data-field="name" value="{{formData.name}}" placeholder="Enter NPC name" style="flex: 1; min-width: 0;">
          <button data-action="randomize-name" title="Generate Random Name" style="width: 36px; height: 36px; padding: 0; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-dice"></i>
          </button>
        </div>
      </div>

      <div style="display: flex; gap: 12px;">
        <div class="form-group" style="flex: 2; min-width: 0;">
          <label for="npc-race">Race</label>
          <select id="npc-race" data-field="race">
            <option value="">-- Select Race --</option>
            {{#each races}}
            <option value="{{this.name}}" {{#if (eq ../formData.race this.name)}}selected{{/if}}>{{this.name}}</option>
            {{/each}}
          </select>
        </div>

        <div class="form-group" style="flex: 2; min-width: 0;">
          <label for="npc-class">Class</label>
          <select id="npc-class" data-field="className">
            <option value="">-- Select Class --</option>
            {{#each classes}}
            <option value="{{this.name}}" {{#if (eq ../formData.className this.name)}}selected{{/if}}>{{this.name}}</option>
            {{/each}}
          </select>
        </div>

        <div class="form-group" style="flex: 1; min-width: 80px;">
          <label for="npc-gender">Gender</label>
          <select id="npc-gender" data-field="gender">
            <option value="male" {{#if (eq formData.gender "male")}}selected{{/if}}>Male</option>
            <option value="female" {{#if (eq formData.gender "female")}}selected{{/if}}>Female</option>
          </select>
        </div>
      </div>

      <div style="display: flex; gap: 12px;">
        <div class="form-group" style="flex: 2; min-width: 0;">
          <label for="npc-alignment">Alignment</label>
          <select id="npc-alignment" data-field="alignment">
            <option value="">-- Select Alignment --</option>
            <option value="Lawful Good" {{#if (eq formData.alignment "Lawful Good")}}selected{{/if}}>Lawful Good</option>
            <option value="Neutral Good" {{#if (eq formData.alignment "Neutral Good")}}selected{{/if}}>Neutral Good</option>
            <option value="Chaotic Good" {{#if (eq formData.alignment "Chaotic Good")}}selected{{/if}}>Chaotic Good</option>
            <option value="Lawful Neutral" {{#if (eq formData.alignment "Lawful Neutral")}}selected{{/if}}>Lawful Neutral</option>
            <option value="Neutral" {{#if (eq formData.alignment "Neutral")}}selected{{/if}}>Neutral</option>
            <option value="Chaotic Neutral" {{#if (eq formData.alignment "Chaotic Neutral")}}selected{{/if}}>Chaotic Neutral</option>
            <option value="Lawful Evil" {{#if (eq formData.alignment "Lawful Evil")}}selected{{/if}}>Lawful Evil</option>
            <option value="Neutral Evil" {{#if (eq formData.alignment "Neutral Evil")}}selected{{/if}}>Neutral Evil</option>
            <option value="Chaotic Evil" {{#if (eq formData.alignment "Chaotic Evil")}}selected{{/if}}>Chaotic Evil</option>
          </select>
        </div>

        <div class="form-group" style="flex: 1; min-width: 80px;">
          <label for="npc-level">Level (1-20)</label>
          <input type="number" id="npc-level" data-field="classLevel" value="{{formData.classLevel}}" min="1" max="20" placeholder="1">
        </div>
      </div>

      <div class="form-group">
        <label for="npc-personality">Personality (Optional)</label>
        <textarea id="npc-personality" data-field="personality" rows="3" placeholder="Brief personality description">{{formData.personality}}</textarea>
      </div>

      <div class="form-group">
        <label for="npc-background">Background (Optional)</label>
        <textarea id="npc-background" data-field="background" rows="3" placeholder="Brief background or history">{{formData.background}}</textarea>
      </div>
    </div>

    <!-- Abilities Tab -->
    <div class="tab" data-tab="abilities">
      <div class="section-header">Ability Scores</div>
      
      <div class="button-group">
        <button data-action="apply-standard-array">
          <i class="fas fa-list-ol"></i> Standard Array
        </button>
        <button data-action="roll-abilities">
          <i class="fas fa-dice"></i> Roll 4d6 Drop Lowest
        </button>
      </div>

      <div class="abilities-grid">
        {{#each abilities}}
        <div class="ability-input">
          <label for="ability-{{this.key}}">{{this.label}}</label>
          <input type="number" 
                 id="ability-{{this.key}}" 
                 data-ability="{{this.key}}" 
                 value="{{this.value}}" 
                 min="3" 
                 max="25">
        </div>
        {{/each}}
      </div>
    </div>

    <!-- Config Tab -->
    <div class="tab" data-tab="config">
      <div class="section-header">Character Options</div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" 
                 data-field="usePcSheet" 
                 {{#if formData.usePcSheet}}checked{{/if}}
                 style="width: 18px; height: 18px;">
          <span style="font-weight: bold;">Use PC Style Sheet</span>
        </label>
        <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-left: 26px; margin-top: 4px;">
          When enabled, creates full PC sheet with class progression and automatic calculations.<br>
          When disabled, creates simplified NPC sheet with manual HP and level.
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" 
                 data-field="useMaxHpPerHD" 
                 {{#if formData.useMaxHpPerHD}}checked{{/if}}
                 style="width: 18px; height: 18px;">
          <span style="font-weight: bold;">Use Max HP per Hit Die</span>
        </label>
        <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-left: 26px; margin-top: 4px;">
          When enabled, awards maximum HP per level (e.g. d10 = 10 HP/level).<br>
          When disabled, rolls HP randomly (max at level 1, random for other levels).
        </div>
      </div>

      <div class="section-header">Budget Options</div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" 
                 data-field="useStandardBudget" 
                 {{#if formData.useStandardBudget}}checked{{/if}}
                 style="width: 18px; height: 18px;">
          <span style="font-weight: bold;">Use Standard Adventurer Budget</span>
        </label>
        <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-left: 26px; margin-top: 4px;">
          When enabled, NPC receives wealth-by-level appropriate gear and magic items.<br>
          When disabled, NPC receives no magic items and only token gold as loot.
        </div>
      </div>

      <div class="section-header">Token Options</div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="font-weight: bold; display: block; margin-bottom: 4px;">Token Disposition</label>
        <select data-field="tokenDisposition" style="width: 200px; padding: 4px 8px;">
          <option value="1" {{#if (eq formData.tokenDisposition 1)}}selected{{/if}}>Friendly</option>
          <option value="0" {{#if (eq formData.tokenDisposition 0)}}selected{{/if}}>Neutral</option>
          <option value="-1" {{#if (eq formData.tokenDisposition -1)}}selected{{/if}}>Hostile</option>
        </select>
        <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-top: 4px;">
          Sets the default disposition for tokens placed from this character.<br>
          Friendly = green border, Neutral = yellow border, Hostile = red border.
        </div>
      </div>

      <div class="section-header">Loot Options</div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" 
                 data-field="identifyItems" 
                 {{#if formData.identifyItems}}checked{{/if}}
                 style="width: 18px; height: 18px;">
          <span style="font-weight: bold;">Identify Magic Items</span>
        </label>
        <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-left: 26px; margin-top: 4px;">
          When enabled, magic items are identified and show their full names.<br>
          When disabled, items appear unidentified (suitable for loot drops).
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" 
                 data-field="extraMoneyInBank" 
                 {{#if formData.extraMoneyInBank}}checked{{/if}}
                 style="width: 18px; height: 18px;">
          <span style="font-weight: bold;">Extra Money in the Bank</span>
        </label>
        <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-left: 26px; margin-top: 4px;">
          When enabled, excess gold becomes a bank deposit slip with only pocket change remaining.<br>
          When disabled, all remaining gold is given as coins.
        </div>
        <div style="margin-left: 26px; margin-top: 8px;">
          <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px;">Bank Name</label>
          <input type="text" 
                 data-field="bankName" 
                 value="{{formData.bankName}}"
                 placeholder="The First Bank of Lower Everbrook"
                 style="width: 100%; max-width: 300px; padding: 4px 8px; font-size: 12px;">
        </div>
      </div>

      {{#if formData.useStandardBudget}}
      <div class="section-header" style="margin-top: 20px;">Magic Item Budget Allocation</div>
      <div style="font-size: 11px; color: var(--color-text-light-6, #999); margin-bottom: 8px; padding: 0 4px;">
        Fine-tune how specific budget categories are split between related items.
      </div>

      {{#if budgetInfo}}
      <div style="background: rgba(0,0,0,0.2); padding: 8px; margin-bottom: 12px; border-radius: 4px; font-size: 12px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
          <div><strong>Total Wealth:</strong> {{budgetInfo.totalWealth}} gp</div>
          <div><strong>Mundane Cost:</strong> {{budgetInfo.mundaneCost}} gp</div>
          <div><strong>Magic Budget:</strong> {{budgetInfo.magicBudget}} gp</div>
        </div>
      </div>
      {{/if}}

      <div class="abilities-grid">
        {{#if budgetInfo}}
        <div style="grid-column: 1 / -1; background: rgba(0,100,200,0.3); padding: 8px; border-left: 3px solid rgba(0,150,255,0.8); margin-bottom: 8px; border-radius: 4px;">
          <div style="font-weight: bold; font-size: 11px; color: #ffffff; margin-bottom: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">ARMOR BUDGET: {{budgetInfo.armorBudgetTotal}} gp</div>
          <div style="font-size: 10px; color: #ffffff; opacity: 0.9;">Split between shield and armor enhancements</div>
        </div>
        {{/if}}

        <div class="ability-input">
          <label for="budget-shield" title="% of armor budget allocated to shield enhancement">
            Shield {{#if budgetInfo}}<span style="font-weight: normal; font-size: 9px; opacity: 0.7;">(of armor budget)</span>{{/if}}
            {{#if budgetInfo}}<span style="display: block; font-size: 10px; font-weight: normal; color: #4ade80;">{{budgetInfo.shieldGP}} gp</span>{{/if}}
          </label>
          <input type="number" 
                 id="budget-shield" 
                 data-budget="shieldPercent" 
                 value="{{formData.magicItemBudgets.shieldPercent}}" 
                 min="0" 
                 max="100"
                 step="5">
        </div>

        <div class="ability-input">
          <label for="budget-armor" title="% of armor budget allocated to armor enhancement">
            Armor {{#if budgetInfo}}<span style="font-weight: normal; font-size: 9px; opacity: 0.7;">(of armor budget)</span>{{/if}}
            {{#if budgetInfo}}<span style="display: block; font-size: 10px; font-weight: normal; color: #4ade80;">{{budgetInfo.armorGP}} gp</span>{{/if}}
          </label>
          <input type="number" 
                 id="budget-armor" 
                 data-budget="armorPercent" 
                 value="{{formData.magicItemBudgets.armorPercent}}" 
                 min="0" 
                 max="100"
                 step="5">
        </div>

        {{#if budgetInfo}}
        <div style="grid-column: 1 / -1; background: rgba(150,50,0,0.3); padding: 8px; border-left: 3px solid rgba(255,150,0,0.8); margin-top: 8px; margin-bottom: 8px; border-radius: 4px;">
          <div style="font-weight: bold; font-size: 11px; color: #ffffff; margin-bottom: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">WEAPON BUDGET: {{budgetInfo.weaponBudgetTotal}} gp</div>
          <div style="font-size: 10px; color: #ffffff; opacity: 0.9;">Split between primary and secondary weapon enhancements</div>
        </div>
        {{/if}}

        <div class="ability-input">
          <label for="budget-secondary" title="% of weapon budget allocated to secondary/off-hand weapon">
            Secondary Weapon {{#if budgetInfo}}<span style="font-weight: normal; font-size: 9px; opacity: 0.7;">(of weapon budget)</span>{{/if}}
            {{#if budgetInfo}}<span style="display: block; font-size: 10px; font-weight: normal; color: #4ade80;">{{budgetInfo.secondaryWeaponGP}} gp</span>{{/if}}
          </label>
          <input type="number" 
                 id="budget-secondary" 
                 data-budget="secondaryWeaponPercent" 
                 value="{{formData.magicItemBudgets.secondaryWeaponPercent}}" 
                 min="0" 
                 max="100"
                 step="5">
        </div>

        {{#if budgetInfo}}
        <div style="grid-column: 1 / -1; background: rgba(100,0,150,0.3); padding: 8px; border-left: 3px solid rgba(200,0,255,0.8); margin-top: 8px; margin-bottom: 8px; border-radius: 4px;">
          <div style="font-weight: bold; font-size: 11px; color: #ffffff; margin-bottom: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">PROTECTION BUDGET: {{budgetInfo.protectionBudgetTotal}} gp</div>
          <div style="font-size: 10px; color: #ffffff; opacity: 0.9;">Split between Ring of Protection and Amulet of Natural Armor</div>
        </div>
        {{/if}}

        <div class="ability-input">
          <label for="budget-ring" title="% of protection budget allocated to Ring of Protection">
            Ring of Protection {{#if budgetInfo}}<span style="font-weight: normal; font-size: 9px; opacity: 0.7;">(of protection budget)</span>{{/if}}
            {{#if budgetInfo}}<span style="display: block; font-size: 10px; font-weight: normal; color: #4ade80;">{{budgetInfo.ringGP}} gp</span>{{/if}}
          </label>
          <input type="number" 
                 id="budget-ring" 
                 data-budget="ringPercent" 
                 value="{{formData.magicItemBudgets.ringPercent}}" 
                 min="0" 
                 max="100"
                 step="5">
        </div>

        <div class="ability-input">
          <label for="budget-amulet" title="% of protection budget allocated to Amulet of Natural Armor">
            Amulet of Nat. Armor {{#if budgetInfo}}<span style="font-weight: normal; font-size: 9px; opacity: 0.7;">(of protection budget)</span>{{/if}}
            {{#if budgetInfo}}<span style="display: block; font-size: 10px; font-weight: normal; color: #4ade80;">{{budgetInfo.amuletGP}} gp</span>{{/if}}
          </label>
          <input type="number" 
                 id="budget-amulet" 
                 data-budget="amuletPercent" 
                 value="{{formData.magicItemBudgets.amuletPercent}}" 
                 min="0" 
                 max="100"
                 step="5">
        </div>

        <div class="ability-input" style="display: flex; align-items: flex-end;">
          <button data-action="reset-budgets" style="width: 100%; height: 36px;" title="Reset all values to current defaults (based on level and template)">
            <i class="fas fa-undo"></i> Reset
          </button>
        </div>
      </div>

      {{#if budgetInfo}}
      <div style="background: rgba(0,0,0,0.2); padding: 8px; margin-top: 12px; border-radius: 4px; font-size: 12px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div>
            <strong>Total Allocated:</strong> {{budgetInfo.totalAllocatedPercent}}%
          </div>
          <div style="{{#if (gt budgetInfo.unallocatedPercent 0)}}color: #5efc82;{{else}}color: #ff6b6b;{{/if}} font-weight: bold;">
            <strong>Unallocated:</strong> {{budgetInfo.unallocatedPercent}}% ({{budgetInfo.unallocatedGP}} gp)
          </div>
        </div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 10px; color: #e0e0e0;">
          <strong>Note:</strong> These percentages are sub-allocations within their parent budgets (Armor, Weapon, Protection). Unallocated funds within each category become extra spending money.
        </div>
      </div>
      {{/if}}
      {{/if}}
    </div>
  </div>

  <!-- Action Buttons -->
  <footer class="button-group" style="padding: 12px 16px; border-top: 1px solid var(--color-border-light-2, #2c2f3a);">
    <button class="primary" data-action="create-npc">
      <i class="fas fa-user-plus"></i> Create NPC
    </button>
    <button data-action="cancel">
      <i class="fas fa-times"></i> Cancel
    </button>
  </footer>

  <!-- Loading Overlay -->
  <div class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <i class="fas fa-spinner fa-spin loading-spinner"></i>
      <div class="loading-title">Creating NPC...</div>
      <div class="loading-step"></div>
      <div class="loading-progress">
        <div class="loading-progress-bar"></div>
      </div>
    </div>
  </div>
</div>
